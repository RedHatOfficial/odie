#!/bin/perl

use strict;

# Create the delta RPMs
my @rpms = `cat /opt/odie/src/conf/*-rpms.txt | grep -v .rpm | sort -u` ;
my $repo = "tmp/delta_rpms";

my $baselineDir = "/opt/odie/baseline";
my $baselineRepo = "tmp/baseline_rpms";

my $cveReport = "";
my $bugFixes = "";

# This function gets various metadata used in the report
sub get_repo($) { 
	my $file = shift;
	my %pack= {};
	$pack{"fileName"} = $file;
	$pack{"packageName"} = `rpm -q -p $file --qf '%{NAME}'`;
	#$pack{"buildTime"} = `rpm -q -p $file --qf '%{BUILDTIME}'`;
	$pack{"packageVersion"} = `rpm -q -p $file --qf '%{VERSION}.%{RELEASE}'`;
	$pack{"CHANGELOG"} = `rpm -q -p $file --changelog`;
  #$pack{"sha256"} = `sha256sum $file`;
	return %pack;
} 

sub diff_cve(@) {
	my %orig_pack = &get_repo($_[0]);
	my %latest_pack = &get_repo($_[-1]);
	my $rpmUpdate = "> " .  $orig_pack{"packageName"} . " " . $orig_pack{"packageVersion"} . " -> " . $latest_pack{"packageVersion"} . "\n";
	my $before = "/tmp/changelogBefore";
	my $after = "/tmp/changelogAfter";
	`rpm -q -p $orig_pack{"fileName"} --changelog > $before`;
	`rpm -q -p $latest_pack{"fileName"} --changelog > $after`;

	my $cve =  ` comm -1 -3 $before $after --nocheck-order | grep CVE ` ;

  if ($cve) {
    $cveReport .= $rpmUpdate;  
    $cveReport .= $cve;
    $cveReport .= "\n";
  }

  $bugFixes .= $rpmUpdate;
} 

for my $package (@rpms) {

	chomp($package);
  $package =~ s/-\${OCP_VERSION}//;
  $package =~ s/-2.2.3.0//;
	my @files = ();
	for (`ls -1rt $baselineRepo/$package* 2>/dev/null`) {
		chomp;
		my $package_name = `rpm -q -p $_ --qf '%{NAME}'`;
		push @files, $_ if $package_name =~ /^$package$/;
	}
	for (`ls -1rt $repo/$package* 2>/dev/null`) {
		chomp;
		my $package_name = `rpm -q -p $_ --qf '%{NAME}'`;
		push @files, $_ if $package_name =~ /^$package$/;
	}

	&diff_cve(@files) if @files > 1;
}

chomp(my $installer = `cat INSTALLER_VERSION`); 
chomp(my $baselineVersion = `cat $baselineDir/INSTALLER_VERSION`);
print "ODIE RPM Manifest for $installer\n";
print "\n";

print "Updated RPMs since Baseline $baselineVersion\n";
print "~~~~~~~~~~~~\n";
print "\n";
print $bugFixes;
print "\n";

print "Addressed CVEs since Baseline $baselineVersion\n";
print "~~~~~~~~~\n";
print "\n";
print $cveReport;
print "\n";

print "SHA256 Checksums\n";
print "~~~~~~~~~~~~~~~~\n";
print "\n\n";
print `cd output/Packages; sha256sum *.rpm`;
